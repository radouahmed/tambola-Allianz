<!DOCTYPE html>
<html lang="fr"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Admin — Tombola Allianz Maroc</title><link rel="stylesheet" href="/style.css"/></head>
<body>
  <div class="header"><img src="/logo-allianz.svg" alt="Allianz" class="logo-img"/><h1>Espace Admin — Tombola Allianz Maroc</h1></div>
  <div class="container">
    <div class="row">
      <div class="card" style="grid-column:1/-1">
        <h2>Données</h2>
        <div id="counts" class="notice">Chargement…</div>
        <table class="table" id="dataTable"><thead><tr>
          <th>ID</th><th>Nom & Prénom</th><th>GSM</th><th>Mois d’échéance</th><th>Compagnie</th><th>Ville</th><th>Quartier</th><th>Intermédiaire Allianz</th><th>Ville (stockée)</th><th>Créé</th><th>Lot</th><th>Tirage</th><th>Jour</th>
        </tr></thead><tbody></tbody></table>
        <div id="pager" class="center" style="margin:12px 0"></div>
        <div class="center" style="margin-top:12px"><a href="/admin/export"><button>Exporter CSV (tout)</button></a></div>
      </div>

      <div class="card">
        <h2>Répartition des lots</h2>
        <ul id="breakdown" class="notice"></ul>
      </div>

      <div class="card">
        <h2>Pondération des lots</h2>
        <div id="weightsWrap" class="notice">Chargement…</div>
        <div class="center" style="margin-top:12px">
          <button id="saveWeightsBtn">Enregistrer</button>
        </div>
        <p class="notice">Astuce : un poids à 0 exclut le lot de la pondération (s'il est éligible côté quotas). Si tous les poids = 0, tirage uniforme.</p>
      </div>

      <div class="card">
        <h2>Plafonds journaliers (par lot)</h2>
        <div id="capsWrap" class="notice">Chargement…</div>
        <div class="center" style="margin-top:12px">
          <button id="saveCapsBtn">Enregistrer</button>
        </div>
        <p class="notice">Laisser vide (ou 0) = illimité. Remise à zéro chaque jour (Fuseau : Africa/Casablanca).</p>
      </div>
    </div>
  </div>

  <script>
    // --- Pagination state ---
    let currentPage = 1;
    const pageSize = 10; // 10 IDs par page
    let totalRows = 0;

    // --- Helper fetch robuste (détecte HTML inattendu) ---
    async function req(url, opts){
      const res = await fetch(url, opts||{});
      const ct = (res.headers.get('content-type')||'').toLowerCase();
      const isJSON = ct.includes('application/json');
      if (!res.ok) {
        const msg = isJSON ? (await res.json()).error : await res.text();
        throw new Error(msg || 'Erreur');
      }
      if (!isJSON) {
        // Par ex., fallback HTML si l’ordre des routes serveur est mauvais
        const txt = await res.text();
        throw new Error('Réponse inattendue (HTML reçu). Vérifie que /admin/data est déclaré AVANT le fallback app.get("*") côté serveur.');
      }
      return res.json();
    }

    // --- Chargement des données paginées ---
    async function loadData() {
      try {
        const data = await req(`/admin/data?page=${currentPage}&pageSize=${pageSize}`);
        totalRows = data.total || 0;

        const tb = document.querySelector('#dataTable tbody');
        tb.innerHTML = '';
        let prizeCounts = {};
        (data.rows || []).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.name}</td>
            <td>${r.phone}</td>
            <td>${r.expiry_month || ''}</td>
            <td>${r.insurance_company || ''}</td>
            <td>${r.city || ''}</td>
            <td>${r.district || ''}</td>
            <td>${r.intermediary || ''}</td>
            <td>${r.zone || ''}</td>
            <td>${new Date(r.created_at).toLocaleString()}</td>
            <td>${r.prize || ''}</td>
            <td>${r.prize_at ? new Date(r.prize_at).toLocaleString() : ''}</td>
            <td>${r.day || ''}</td>`;
          tb.appendChild(tr);
          if (r.prize) prizeCounts[r.prize] = (prizeCounts[r.prize] || 0) + 1;
        });

        document.getElementById('counts').textContent =
          `${totalRows} participations (page ${data.page}/${Math.max(1, Math.ceil(totalRows / pageSize))})`;

        const br = document.getElementById('breakdown');
        br.innerHTML = '';
        Object.keys(prizeCounts).sort().forEach(k => {
          const li = document.createElement('li');
          li.textContent = k + ': ' + prizeCounts[k];
          br.appendChild(li);
        });

        renderPager();
      } catch (e) {
        console.error(e);
        document.getElementById('counts').textContent = 'Erreur de chargement des données.';
      }
    }

    // --- Rendu pagination ---
    function renderPager() {
      const pager = document.getElementById('pager');
      const pages = Math.max(1, Math.ceil(totalRows / pageSize));
      const p = currentPage;

      const btn = (label, disabled, onClick) => {
        const b = document.createElement('button');
        b.textContent = label;
        b.disabled = !!disabled;
        b.style.margin = '0 6px';
        b.addEventListener('click', onClick);
        return b;
      };

      pager.innerHTML = '';
      pager.appendChild(btn('⟪ Première', p === 1, () => { currentPage = 1; loadData(); }));
      pager.appendChild(btn('‹ Précédente', p === 1, () => { currentPage = Math.max(1, p - 1); loadData(); }));

      const info = document.createElement('span');
      info.className = 'badge';
      info.style.margin = '0 8px';
      info.textContent = `Page ${p} / ${pages}`;
      pager.appendChild(info);

      pager.appendChild(btn('Suivante ›', p === pages, () => { currentPage = Math.min(pages, p + 1); loadData(); }));
      pager.appendChild(btn('Dernière ⟫', p === pages, () => { currentPage = pages; loadData(); }));
    }

    // --- Pondération / Plafonds (inchangés) ---
    async function loadWeightsUI(){
      try{
        const data = await req('/admin/weights');
        const wrap = document.getElementById('weightsWrap');
        const tbl = document.createElement('table');
        tbl.className = 'table';
        tbl.innerHTML = '<thead><tr><th>Lot</th><th>Poids</th><th>% (actuel)</th></tr></thead><tbody></tbody>';
        const tb = tbl.querySelector('tbody');
        data.weights.forEach(w=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${w.prize}</td>
            <td><input type="number" min="0" step="0.1" value="${w.weight}" data-prize="${w.prize}" style="width:120px"/></td>
            <td>${(w.percent||0).toFixed(1)}%</td>`;
          tb.appendChild(tr);
        });
        wrap.innerHTML = '';
        wrap.appendChild(tbl);
      }catch(e){
        console.error(e);
        document.getElementById('weightsWrap').textContent = 'Erreur de chargement.';
      }
    }

    async function saveWeightsUI(){
      const inputs = Array.from(document.querySelectorAll('#weightsWrap input[data-prize]'));
      const payload = { weights: {} };
      inputs.forEach(inp => payload.weights[inp.getAttribute('data-prize')] = Number(inp.value) || 0);
      try{
        await req('/admin/weights', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        alert('Pondération enregistrée');
        loadWeightsUI();
      }catch(e){ alert('Erreur : ' + e.message); }
    }

    async function loadCapsUI(){
      try{
        const data = await req('/admin/caps');
        const wrap = document.getElementById('capsWrap');
        const tbl = document.createElement('table');
        tbl.className = 'table';
        tbl.innerHTML = '<thead><tr><th>Lot</th><th>Plafond/jour</th><th>Distribué (aujourd’hui)</th><th>Restant</th></tr></thead><tbody></tbody>';
        const tb = tbl.querySelector('tbody');
        data.caps.forEach(c=>{
          const tr = document.createElement('tr');
          const capVal = (c.cap==null || c.cap<=0) ? '' : c.cap;
          const rest = (c.remaining==null) ? '—' : c.remaining;
          tr.innerHTML = `<td>${c.prize}</td>
            <td><input type="number" min="0" step="1" value="${capVal}" data-prize="${c.prize}" style="width:120px"/></td>
            <td>${c.used}</td>
            <td>${rest}</td>`;
          tb.appendChild(tr);
        });
        wrap.innerHTML = '';
        wrap.appendChild(tbl);
      }catch(e){
        console.error(e);
        document.getElementById('capsWrap').textContent = 'Erreur de chargement.';
      }
    }

    async function saveCapsUI(){
      const inputs = Array.from(document.querySelectorAll('#capsWrap input[data-prize]'));
      const payload = { caps: {} };
      inputs.forEach(inp => {
        const v = inp.value.trim();
        payload.caps[inp.getAttribute('data-prize')] = (v === '' ? null : Number(v)||0);
      });
      try{
        await req('/admin/caps', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        alert('Plafonds enregistrés');
        loadCapsUI();
      }catch(e){ alert('Erreur : ' + e.message); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      loadData();
      loadWeightsUI();
      loadCapsUI();
      const bw = document.getElementById('saveWeightsBtn');
      const bc = document.getElementById('saveCapsBtn');
      if (bw) bw.addEventListener('click', saveWeightsUI);
      if (bc) bc.addEventListener('click', saveCapsUI);
    });
  </script>
</body></html>
